<%- include('../partials/admin/header') %>
<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;
    }


    .sidebar a:hover {
        background: #34495e;
    }

    .content-area {
        margin-left: 250px;
        padding: 20px;
        width: calc(100% - 250px);
        box-sizing: border-box;
    }

    .card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .content-header {
        padding: 20px;
        border-bottom: 1px solid #eee;
    }

    .content-title {
        margin: 0;
    }

    .btn-primary {
        background: #007bff;
        color: white;
        border: none;
        padding: 5px 15px;
        cursor: pointer;
    }

    .btn-primary:hover {
        background: #0056b3;
    }

    .search-container {
 
        margin-bottom: 20px;

    }

    .table-responsive {
        overflow-x: auto;
        width: 100%;
    }

    .table {
        width: 100%;
        border-collapse: collapse;
    }

    .table th, .table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
        word-wrap: break-word;
        max-width: 0;
        overflow-wrap: break-word;
    }

    .table th {
        background: #f8f9fa;
    }

    .table td {
        vertical-align: middle;
    }

    .actions .btn {
        margin-right: 5px;
    }

    .pagination-container {
        padding: 20px;
        text-align: center;
    }

    .pagination-container a {
        margin: 0 5px;
        text-decoration: none;
        color: #007bff;
    }

    .pagination-container .current-page {
        font-weight: bold;
        color: #000;
        padding: 5px;
    }
</style>

<div class="content-area">
    <div class="card">
        <div class="content-header">
            <h2 class="content-title">Offers List</h2>
            <a href="/admin/offer" class="btn btn-primary">Add New Offer</a>
        </div>
          <div class="search-container">
                <form class="d-flex" method="GET" action="/admin/offer-list">
                    <input class="form-control me-2" type="search" name="search" placeholder="Search by Offer Name or Type" aria-label="Search" value="<%= searchQuery || '' %>">
                    <button class="btn btn-outline-primary" type="submit">Search</button>
                </form>
            </div>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Offer Name</th>
                        <th>Type</th>
                        <th>Discount (%)</th>
                        <th>Product Id</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <% if (offers && offers.length > 0) { %>
                        <% offers.forEach(offer => { %>
                            <tr>
                                <td><%= offer.name || 'N/A' %></td>
                                <td><%= (offer.type && offer.type.charAt(0).toUpperCase() + offer.type.slice(1)) || 'N/A' %></td>
                                <td><%= offer.discount || 'N/A' %></td>
                                <td>
                                    <% if (offer.type === 'product') { %>
                                        <%= offer.productId || 'N/A' %>
                                    <% } else if (offer.type === 'category') { %>
                                        <%= offer.categoryId || 'N/A' %>
                                    <% } else { %>
                                        <%= offer.referralCode || 'N/A' %>
                                    <% } %>
                                </td>
                                <td class="actions">
                                    <button class="btn btn-primary btn-sm" onclick="editOffer('<%= JSON.stringify(offer) %>')">Edit</button>
                                    <button class="btn btn-danger btn-sm" onclick="removeOffer('<%= offer._id %>')">Remove</button>
                                </td>
                            </tr>
                        <% }); %>
                    <% } else { %>
                        <tr>
                            <td colspan="5">No offers found.</td>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
        <div class="pagination-container">
            <% if (currentPage > 1) { %>
                <a href="?page=<%= currentPage - 1 %>&search=<%= searchQuery || '' %>"></a>
            <% } %>
            <% for (let i = 1; i <= totalPages; i++) { %>
                <% if (i === currentPage) { %>
                    <span class="current-page"><%= i %></span>
                <% } else { %>
                    <a href="?page=<%= i %>&search=<%= searchQuery || '' %>"><%= i %></a>
                <% } %>
            <% } %>
            <% if (currentPage < totalPages) { %>
                <a href="?page=<%= currentPage + 1 %>&search=<%= searchQuery || '' %>"></a>
            <% } %>
        </div>
    </div>
</div>

<!-- Edit Offer Modal -->
<div class="modal fade" id="editOfferModal" tabindex="-1" aria-labelledby="editOfferModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editOfferModalLabel">Edit Offer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editOfferForm">
                    <input type="hidden" id="editOfferId">
                    <div class="mb-3">
                        <label for="editOfferDiscount" class="form-label">Discount (%)</label>
                        <input type="number" class="form-control" id="editOfferDiscount" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="updateOffer()">Save changes</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function editOffer(offerData) {
        const offer = JSON.parse(offerData);
        document.getElementById('editOfferId').value = offer._id;
        document.getElementById('editOfferDiscount').value = offer.discount;
        new bootstrap.Modal(document.getElementById('editOfferModal')).show();
    }

    function updateOffer() {
        const offerId = document.getElementById('editOfferId').value;
        const updatedOffer = { discount: document.getElementById('editOfferDiscount').value };
        fetch(`/admin/offer-update/${offerId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedOffer)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire('Updated!', 'Offer has been updated successfully.', 'success').then(() => location.reload());
            } else {
                Swal.fire('Error!', data.message || 'Something went wrong!', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire('Error!', 'Something went wrong!', 'error');
        });
    }

    function removeOffer(offerId) {
        Swal.fire({
            title: 'Are you sure?',
            text: 'You won\'t be able to revert this!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#3085d6',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/admin/offer-remove/${offerId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire('Deleted!', data.message, 'success').then(() => location.reload());
                    } else {
                        Swal.fire('Error!', data.message, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    Swal.fire('Error!', 'Something went wrong!', 'error');
                });
            }
        });
    }
</script>